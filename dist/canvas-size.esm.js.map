{"version":3,"file":"canvas-size.esm.js","sources":["../src/worker.js","../src/create-worker.js","../src/index.js"],"sourcesContent":["/* istanbul ignore next */\nexport default function canvasWorker() {\n    function canvasTest(settings) {\n        const { job, width, height, fill } = settings;\n        const cvs = new OffscreenCanvas(width, height);\n        const ctx = cvs.getContext('2d');\n\n        ctx.fillRect.apply(ctx, fill);\n\n        // Verify image data (Pass = 255, Fail = 0)\n        const isTestPass = Boolean(ctx.getImageData.apply(ctx, fill).data[3]);\n\n        self.postMessage({\n            job,\n            width,\n            height,\n            isTestPass\n        });\n    }\n\n    self.onmessage = function(e) {\n        canvasTest(e.data);\n    };\n}\n","function createWorker(fn) {\n    const js      = `(${fn.toString()})()`;\n    const blob    = new Blob([js], { type: 'application/javascript' });\n    const blobURL = URL.createObjectURL(blob);\n    const worker  = new Worker(blobURL);\n\n    URL.revokeObjectURL(blobURL);\n\n    return worker;\n}\n\nexport default createWorker;\n","import canvasWorker from './worker.js';\nimport createWorker from './create-worker.js';\n\n\n// Constants & Variables\n// =============================================================================\nconst defaults = {\n    max  : null,\n    min  : 1,\n    sizes: [],\n    step : 1024,\n    // Callbacks\n    onError  : Function.prototype,\n    onSuccess: Function.prototype\n};\nconst testSizes = {\n    area: [\n        // Chrome 70 (Mac, Win)\n        // Chrome 68 (Android 4.4)\n        // Edge 17 (Win)\n        // Safari 7-12 (Mac)\n        16384,\n        // Chrome 68 (Android 7.1-9)\n        14188,\n        // Chrome 68 (Android 5),\n        11402,\n        // Chrome 68 (Android 6)\n        10836,\n        // Firefox 63 (Mac, Win)\n        11180,\n        // IE 9-11 (Win)\n        8192,\n        // IE Mobile (Windows Phone 8.x)\n        // Safari (iOS 9 - 12)\n        4096,\n        // Failed\n        defaults.min\n    ],\n    height: [\n        // Safari 7-12 (Mac)\n        // Safari (iOS 9-12)\n        8388607,\n        // Chrome ??\n        65535,\n        // Chrome 70 (Mac, Win)\n        // Chrome 68 (Android 4.4-9)\n        // Firefox 63 (Mac, Win)\n        32767,\n        // IE11\n        // Edge 17 (Win)\n        16384,\n        // IE 9-10 (Win)\n        8192,\n        // IE Mobile (Windows Phone 8.x)\n        4096,\n        // Failed\n        defaults.min\n    ],\n    width: [\n        // Safari 7-12 (Mac)\n        // Safari (iOS 9-12)\n        4194303,\n        // Chrome ??\n        65535,\n        // Chrome 70 (Mac, Win)\n        // Chrome 68 (Android 4.4-9)\n        // Firefox 63 (Mac, Win)\n        32767,\n        // IE11\n        // Edge 17 (Win)\n        16384,\n        // IE 9-10 (Win)\n        8192,\n        // IE Mobile (Windows Phone 8.x)\n        4096,\n        // Failed\n        defaults.min\n    ]\n};\n\n// Web worker reference\nlet worker;\n\n// Generate inline web worker\nif (window && ('OffscreenCanvas' in window) && ('Worker' in window)) {\n    worker = createWorker(canvasWorker);\n    worker.onmessage = function(e) {\n        const { job, width, height, isTestPass } = e.data;\n\n        document.dispatchEvent(\n            // Dispatch custom event\n            new CustomEvent(job, {\n                detail: {\n                    width,\n                    height,\n                    isTestPass,\n                    benchmark: (Date.now() - job) // milliseconds\n                }\n            })\n        );\n    };\n}\n\n\n// Functions (Private)\n// =============================================================================\n/**\n * Tests ability to read pixel data from a canvas at a specified dimension.\n *\n * @param {object} settings\n * @param {number} settings.width\n * @param {number} settings.height\n * @param {function} settings.onError\n * @param {function} settings.onSuccess\n */\nfunction canvasTest(settings) {\n    const { width, height } = settings;\n    const fill = [width - 1, height - 1, 1, 1]; // x, y, width, height\n    const job  = Date.now();\n\n    // Web worker\n    if (worker) {\n        // Listen for custom job event\n        document.addEventListener(job, function(e) {\n            const { width, height, isTestPass, benchmark } = e.detail;\n\n            if (isTestPass) {\n                settings.onSuccess(width, height, benchmark);\n            }\n            else {\n                settings.onError(width, height);\n            }\n        }, false);\n\n        // Send canvas reference and test data to web worker\n        worker.postMessage({\n            job,\n            width,\n            height,\n            fill\n        });\n    }\n    else {\n        try {\n            const cvs = document.createElement('canvas');\n            const ctx = cvs.getContext('2d');\n\n            cvs.width = width;\n            cvs.height = height;\n            ctx.fillRect.apply(ctx, fill);\n\n            // Verify image data (Pass = 255, Fail = 0)\n            const isTestPass = Boolean(ctx.getImageData.apply(ctx, fill).data[3]);\n\n            if (isTestPass) {\n                const benchmark = Date.now() - job; // milliseconds\n\n                settings.onSuccess(width, height, benchmark);\n            }\n            else {\n                settings.onError(width, height);\n            }\n        }\n        catch(e){\n            settings.onError(width, height);\n        }\n    }\n}\n\n/**\n * Tests ability to read pixel data from canvas elements of various dimensions\n * by decreasing canvas height and/or width until a test succeeds.\n *\n * @param {object} settings\n * @param {number[][]} settings.sizes\n * @param {function} settings.onError\n * @param {function} settings.onSuccess\n */\nfunction canvasTestLoop(settings) {\n    const sizes  = settings.sizes.shift();\n    const width  = sizes[0];\n    const height = sizes[1];\n\n    canvasTest({\n        width,\n        height,\n        onError(width, height) {\n            settings.onError(width, height);\n\n            if (settings.sizes.length) {\n                canvasTestLoop(settings);\n            }\n        },\n        onSuccess: settings.onSuccess\n    });\n}\n\n/**\n * Creates a 2d array of canvas dimensions either from the default testSizes\n * object or the width/height/min/step values provided.\n *\n * @param   {object} settings\n * @param   {number} settings.width\n * @param   {number} settings.height\n * @param   {number} settings.min\n * @param   {number} settings.step\n * @param   {number[][]} settings.sizes\n * @returns {number[][]}\n */\nfunction createSizesArray(settings) {\n    const isArea   = settings.width === settings.height;\n    const isWidth  = settings.height === 1;\n    const isHeight = settings.width === 1;\n    const sizes    = [];\n\n    // Use settings.sizes\n    if (!settings.width || !settings.height) {\n        settings.sizes.forEach(testSize => {\n            const width  = isArea || isWidth ? testSize : 1;\n            const height = isArea || isHeight ? testSize : 1;\n\n            sizes.push([width, height]);\n        });\n    }\n    // Generate sizes from width, height, and step\n    else {\n        const testMin  = settings.min || defaults.min;\n        const testStep = settings.step || defaults.step;\n        let   testSize = Math.max(settings.width, settings.height);\n\n        while (testSize > testMin) {\n            const width  = isArea || isWidth ? testSize : 1;\n            const height = isArea || isHeight ? testSize : 1;\n\n            sizes.push([width, height]);\n            testSize -= testStep;\n        }\n\n        sizes.push([testMin, testMin]);\n    }\n\n    return sizes;\n}\n\n\n// Methods\n// =============================================================================\nconst canvasSize = {\n    /**\n     * Determines maximum area of an HTML canvas element. When `max` is\n     * unspecified, an optimized test will be performed using known maximum\n     * values from a variety of browsers and platforms.\n     *\n     * @param {object} [options]\n     * @param {number} [options.max]\n     * @param {number} [options.min=1]\n     * @param {number} [options.step=1024]\n     * @param {function} [options.onError]\n     * @param {function} [options.onSuccess]\n     */\n    maxArea(options = {}) {\n        const sizes = createSizesArray({\n            width : options.max,\n            height: options.max,\n            min   : options.min,\n            step  : options.step,\n            sizes : [...testSizes.area]\n        });\n        const settings = Object.assign({}, defaults, options, { sizes });\n\n        canvasTestLoop(settings);\n    },\n\n    /**\n     * Determines maximum height of an HTML canvas element. When `max` is\n     * unspecified, an optimized test will be performed using known maximum\n     * values from a variety of browsers and platforms.\n     *\n     * @param {object} [options]\n     * @param {number} [options.max]\n     * @param {number} [options.min=1]\n     * @param {number} [options.step=1024]\n     * @param {function} [options.onError]\n     * @param {function} [options.onSuccess]\n     */\n    maxHeight(options = {}) {\n        const sizes = createSizesArray({\n            width : 1,\n            height: options.max,\n            min   : options.min,\n            step  : options.step,\n            sizes : [...testSizes.height]\n        });\n        const settings = Object.assign({}, defaults, options, { sizes });\n\n        canvasTestLoop(settings);\n    },\n\n    /**\n     * Determines maximum width of an HTML canvas element. When `max` is\n     * unspecified, an optimized test will be performed using known maximum\n     * values from a variety of browsers and platforms.\n     *\n     * @param {object} [options]\n     * @param {number} [options.max]\n     * @param {number} [options.min=1]\n     * @param {number} [options.step=1024]\n     * @param {function} [options.onError]\n     * @param {function} [options.onSuccess]\n     */\n    maxWidth(options = {}) {\n        const sizes = createSizesArray({\n            width : options.max,\n            height: 1,\n            min   : options.min,\n            step  : options.step,\n            sizes : [...testSizes.width]\n        });\n        const settings = Object.assign({}, defaults, options, { sizes });\n\n        canvasTestLoop(settings);\n    },\n\n    /**\n     * Tests ability to read pixel data from canvas of specified dimension(s).\n     *\n     * @param {object} [options]\n     * @param {number} [options.width]\n     * @param {number} [options.height]\n     * @param {number[][]} [options.sizes]\n     * @param {function} [options.onError]\n     * @param {function} [options.onSuccess]\n     */\n    test(options = {}) {\n        const settings = Object.assign({}, defaults, options);\n\n        if (settings.sizes.length) {\n            settings.sizes = [...options.sizes];\n            canvasTestLoop(settings);\n        }\n        else {\n            canvasTest(settings);\n        }\n    }\n};\n\n\n// Exports\n// =============================================================================\nexport default canvasSize;"],"names":["canvasWorker","canvasTest","settings","job","width","height","fill","cvs","OffscreenCanvas","ctx","getContext","fillRect","apply","isTestPass","Boolean","getImageData","data","self","postMessage","onmessage","e","createWorker","fn","js","toString","blob","Blob","type","blobURL","URL","createObjectURL","worker","Worker","revokeObjectURL","defaults","max","min","sizes","step","onError","Function","prototype","onSuccess","testSizes","area","window","document","dispatchEvent","CustomEvent","detail","benchmark","Date","now","addEventListener","createElement","canvasTestLoop","shift","length","createSizesArray","isArea","isWidth","isHeight","forEach","testSize","push","testMin","testStep","Math","canvasSize","maxArea","options","Object","assign","maxHeight","maxWidth","test"],"mappings":"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"}